#!/bin/bash
# Copyright (c) 2016, the Dartino project authors. Please see the AUTHORS file
# for details. All rights reserved. Use of this source code is governed by a
# BSD-style license that can be found in the LICENSE.md file.

# Script to run Emul8 with a given script.  The script contains the specific
# image and board name and is generated by the 'dartino emulate' command.

set -e
set -x

SCRIPT_NAME="$0"

function usage() {
  echo "Usage: $SCRIPT_NAME <script file>"
  exit 1;
}

SCRIPT_FILE="$1"
if [ ! -z "$2" ]; then
    echo "Additional arguments after script file not supported."
    usage
fi

# Check that the script file exists
if [ ! -e "$SCRIPT_FILE" ]; then
  echo "Script file does not exist: $SCRIPT_FILE."
  usage
fi

OS="`uname`"
case $OS in
  'Linux')
    OS='linux'
    ;;
  'Darwin')
    OS='mac'
    ;;
  *)
    echo "Unsupported OS $OS"
    exit 1
    ;;
esac

function follow_links() {
  file="$1"
  while [ -h "$file" ]; do
    # On Mac OS, readlink -f doesn't work.
    file="$(readlink "$file")"
  done
  echo "$file"
}

# Unlike $0, $BASH_SOURCE points to the absolute path of this file.
PROG_NAME="$(follow_links "$BASH_SOURCE")"

# Handle the case where dartino-sdk/bin has been symlinked to.
SCRIPT_DIR="$(cd "${PROG_NAME%/*}" ; pwd -P)"

source "$SCRIPT_DIR/setup-paths.shlib"

EMUL8_DIRECTORY=$EMUL8_HOME/emul8_bundle
MONO_DIRECTORY=$EMUL8_HOME/mono-build
EMUL_EXECUTABLE=$EMUL8_DIRECTORY/CLI.exe

if [ ! -e "$EMUL_EXECUTABLE"]; then
  echo "Could not find emul8 in $EMUL_DIRECTORY."
fi

export DYLD_FALLBACK_LIBRARY_PATH=$MONO_DIRECTORY/lib:$DYLD_LIBRARY_FALLBACK_PATH
export LD_LIBRARY_PATH=$MONO_DIRECTORY/lib:$LD_LIBRARY_PATH
export C_INCLUDE_PATH=$MONO_DIRECTORY/include
export ACLOCAL_PATH=$MONO_DIRECTORY/share/aclocal
export PKG_CONFIG_PATH=$MONO_DIRECTORY/lib/pkgconfig
export PATH=$MONO_DIRECTORY/bin:$PATH

mono $EMUL_EXECUTABLE $SCRIPT_FILE
